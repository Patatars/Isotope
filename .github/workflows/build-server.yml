name: Build Windows Dedicated Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-server:
    runs-on: windows-2022

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Setup Git credentials for Epic
        run: |
          git config --global url."https://${{ secrets.EPIC_GITHUB_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"
          git config --global core.longpaths true

      - name: Clone Unreal Engine 5.6.1
        run: |
          git clone --branch 5.6.1 --depth=1 https://github.com/EpicGames/UnrealEngine.git
        env:
          GIT_TERMINAL_PROMPT: 0

      - name: Install .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Run Setup.bat
        working-directory: UnrealEngine
        run: |
          echo "Running Unreal Setup..."
          cmd /c Setup.bat

      - name: Generate Project Files
        working-directory: UnrealEngine
        run: |
          echo "Generating project files..."
          cmd /c GenerateProjectFiles.bat

      - name: Build Unreal Engine (Development Editor)
        working-directory: UnrealEngine
        run: |
          echo "Building Unreal Engine..."
          cmd /c Engine\\Build\\BatchFiles\\Build.bat UnrealEditor Win64 Development -WaitMutex -FromMsBuild

      - name: Build Dedicated Server
        run: |
          echo "Building dedicated server..."
          cmd /c UnrealEngine\\Engine\\Build\\BatchFiles\\RunUAT.bat BuildCookRun ^
            -project="$(pwd)\\Isotope2\\Isotope2.uproject" ^
            -noP4 ^
            -platform=Win64 ^
            -clientconfig=Development ^
            -serverconfig=Development ^
            -cook ^
            -build ^
            -stage ^
            -pak ^
            -archive ^
            -archivedirectory="$(pwd)\\BuildOutput" ^
            -server ^
            -nocompileeditor ^
            -utf8output

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Isotope2-DedicatedServer
          path: BuildOutput/
