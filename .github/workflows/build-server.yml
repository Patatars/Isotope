name: Build Dedicated Server

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-server:
    name: Build Isotope2 Dedicated Server
    runs-on: windows-latest

    env:
      UE_VERSION: 5.6.1
      PROJECT_NAME: Isotope2
      EPIC_GITHUB_TOKEN: ${{ secrets.EPIC_GITHUB_TOKEN }}

    steps:
      # 1️⃣ Клонируем репозиторий с проектом
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 2️⃣ Настраиваем доступ к приватным UE-репам (Engine source)
      - name: Authenticate with Epic Games GitHub
        run: |
          git config --global url."https://${{ secrets.EPIC_GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      # 3️⃣ Устанавливаем Unreal Engine (официальный Action)
      - name: Setup Unreal Engine
        uses: EpicGames/ue-build@v2
        with:
          version: ${{ env.UE_VERSION }}
          token: ${{ secrets.EPIC_GITHUB_TOKEN }}

      # 4️⃣ Собираем Dedicated Server
      - name: Build Dedicated Server
        run: |
          echo "Building Dedicated Server for $env:PROJECT_NAME..."
          ue4 build $env:PROJECT_NAME Server Win64 Development -project="$(pwd)\$env:PROJECT_NAME.uproject" -waitmutex -NoHotReloadFromIDE

      # 5️⃣ Собираем билд для упаковки
      - name: Package Dedicated Server
        run: |
          echo "Packaging Dedicated Server..."
          ue4 package $env:PROJECT_NAME Server Win64 Development -project="$(pwd)\$env:PROJECT_NAME.uproject" -stage -archive -archivedirectory="$(pwd)\BuildOutput"

      # 6️⃣ Загружаем билд как артефакт
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Isotope2-DedicatedServer
          path: BuildOutput/
