name: Build UE5 Dedicated Server (Docker)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
    
    - name: Build Server in Docker
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/project \
          ghcr.io/epicgames/unreal-engine:dev-5.6 \
          /bin/bash -c "\
            cd /project && \
            /UnrealEngine/Engine/Build/BatchFiles/RunUAT.sh BuildCookRun \
              -project=/project/Isotope2.uproject \
              -noP4 \
              -platform=Linux \
              -clientconfig=Development \
              -serverconfig=Development \
              -cook \
              -server \
              -noclient \
              -build \
              -stage \
              -pak \
              -archive \
              -archivedirectory=/project/Build"
    
    - name: Upload Server Build
      uses: actions/upload-artifact@v4
      with:
        name: Isotope2-DedicatedServer-Linux
        path: Build/LinuxServer/
        retention-days: 30