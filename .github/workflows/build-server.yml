name: Build UE5 Dedicated Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Checkout UE5 Source
      uses: actions/checkout@v4
      with:
        repository: EpicGames/UnrealEngine
        ref: 5.6.1-release
        token: ${{ secrets.EPIC_GITHUB_TOKEN }}
        path: UnrealEngine
        lfs: true
    
    - name: Setup UE5 Build Tools
      run: |
        cd UnrealEngine
        .\Setup.bat
        .\GenerateProjectFiles.bat
      shell: cmd
    
    - name: Build UnrealBuildTool
      run: |
        cd UnrealEngine
        msbuild Engine\Source\Programs\UnrealBuildTool\UnrealBuildTool.csproj /p:Configuration=Development /p:Platform=AnyCPU
      shell: cmd
    
    - name: Generate Project Files
      run: |
        cd ${{ github.workspace }}
        ${{ github.workspace }}\UnrealEngine\Engine\Build\BatchFiles\Build.bat -projectfiles -project="${{ github.workspace }}\Isotope2.uproject" -game -engine
      shell: cmd
    
    - name: Build Dedicated Server
      run: |
        cd UnrealEngine
        .\Engine\Build\BatchFiles\RunUAT.bat BuildCookRun `
          -project="${{ github.workspace }}\Isotope2.uproject" `
          -noP4 `
          -platform=Win64 `
          -serverplatform=Win64 `
          -clientconfig=Development `
          -serverconfig=Development `
          -cook `
          -server `
          -noclient `
          -build `
          -stage `
          -pak `
          -archive `
          -archivedirectory="${{ github.workspace }}\Build"
      shell: powershell
    
    - name: Upload Server Build
      uses: actions/upload-artifact@v4
      with:
        name: Isotope2-DedicatedServer-Win64
        path: Build/WindowsServer/
        retention-days: 30
    
    - name: Create Release (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: Build/WindowsServer/**/*
        tag_name: server-${{ github.run_number }}
        name: Dedicated Server Build ${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}